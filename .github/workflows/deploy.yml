name: éƒ¨ç½²tgmeng-api

on:
  push:
    branches:
      - main  # è§¦å‘æ¡ä»¶ï¼Œæ ¹æ®ä½ çš„éœ€æ±‚é€‰æ‹©åˆ†æ”¯
    tags:
      - 'v*'  # è§¦å‘ Release åˆ›å»ºçš„æ ‡ç­¾æ¨¡å¼ï¼Œä¾‹å¦‚ v1.0.0ã€‚æ„æ€å°±æ˜¯å½“ä½ åˆ›å»ºä¸€ä¸ªä»¥vå¼€å¤´çš„tagæ—¶ï¼Œä¼šè‡ªåŠ¨å‘å¸ƒreleaseï¼Œè¿™éƒ¨åˆ†è‡ªåŠ¨å‘å¸ƒreleaseçš„é…ç½®åœ¨æœ€åé¢é‚£é‡Œï¼Œç¿»ä¸‹å»çœ‹

concurrency: # å¦‚æœå¤šä¸ªéƒ¨ç½²åŒæ—¶è§¦å‘ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨ä¸Šçš„ JAR æ–‡ä»¶å†²çªæˆ–è¦†ç›–ã€‚å»ºè®®ä½¿ç”¨ concurrency é™åˆ¶åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªéƒ¨ç½²è¿è¡Œ
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true


permissions:
  contents: write  # è¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†åœ¨æäº¤tagæ—¶ä»–è‡ªåŠ¨åˆ›å»ºreleaseå’Œä¸Šä¼ jaråŒ…éœ€è¦è¿™å„¿æƒé™
  packages: write  # æ·»åŠ å¯¹ packages çš„å†™å…¥æƒé™ï¼Œä»¥ä¾¿æ¨é€ GHCR é•œåƒï¼ˆgithub repository container registerï¼‰

jobs:
  deploy:
    runs-on: ubuntu-latest   # é€‰æ‹©è¿è¡Œç¯å¢ƒï¼Œubuntu-latest æ˜¯ Linux ç³»ç»Ÿ
    timeout-minutes: 30      # å•ä½ï¼šåˆ†é’Ÿ  å½“å‰çš„å·¥ä½œæµæ²¡æœ‰è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚å¦‚æœæŸä¸ªæ­¥éª¤ï¼ˆå¦‚ Maven æ„å»ºæˆ– SSH å‘½ä»¤ï¼‰å¡ä½ï¼Œå¯èƒ½å¯¼è‡´å·¥ä½œæµé•¿æ—¶é—´æŒ‚èµ·
    env:
      SERVER_HOST: ${{ secrets.SERVER_IP }}                          # æœåŠ¡å™¨ IP  åœ¨https://github.com/ç”¨æˆ·å/ä»“åº“å/settings/secrets/actions é‡Œè®¾ç½® Repository secrets
      SERVER_USER: ${{ secrets.SERVER_USER }}                        # æœåŠ¡å™¨ç”¨æˆ·å
      SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}                # æœåŠ¡å™¨å¯†ç 
      SERVER_PORT: 22                                                # æœåŠ¡å™¨ç«¯å£
      JAVA_VERSION: '21'                                             # javaç‰ˆæœ¬
      REMOTE_JAR_DIR: /home/${{ secrets.SERVER_USER }}/tgmeng-api    # éƒ¨ç½²ç›®å½•ï¼Œæˆ‘æ˜¯rootç”¨æˆ·ç™»å½•ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¼šå˜æˆ/home/root/tgmeng-api
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}          # DockerHub ç”¨æˆ·å
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}                # DockerHub è®¿é—®ä»¤ç‰Œ
      DOCKER_IMAGE_NAME: tgmeng-api                                  # DockerHub é•œåƒåç§°ï¼ˆä¹Ÿå°±æ˜¯dockerHubé‡Œé¢çš„ä»“åº“çš„åå­—ï¼‰
      GHCR_IMAGE_NAME: tgmeng-api                                   # GHCR é•œåƒåç§°ï¼ˆå»ºè®®æ˜¯ä»“åº“åï¼‰
      # è¿™é‡Œæ ¼å¼ä¸º
      #  [
      #    {
      #      "platform":"OPENAI",  æ³¨æ„ï¼šè¿™é‡Œå¡«çš„æ˜¯AIPlatFormEnumæšä¸¾ç±»çš„keyå€¼
      #      "model": "GPT3",      æ³¨æ„ï¼šè¿™é‡Œå¡«çš„æ˜¯AIModelEnumæšä¸¾ç±»çš„keyå€¼
      #      "key": "sk-1234567890abcdef1234567890abcdef",
      #      "from": "æŸæŸå¹³å°çš„æŸæŸè€å“¥"
      #    },
      #    {
      #      "platform":"DEEPSEEK",
      #      "model": "DEEPSEEK",
      #      "key": "sk-1234567890abcdef1234567890abcdef",
      #      "from": "æŸæŸå¹³å°çš„æŸæŸè€å“¥"
      #    }
      #   ......
      #  ]
      AI_PLATFORM_CONFIG: ${{ secrets.AI_PLATFORM_CONFIG }}

    steps:
      # è·å–ä»£ç å¹¶æ„å»ºé¡¹ç›®
      - name: æ‹‰å–é¡¹ç›®ä»£ç 
        uses: actions/checkout@v4

      # å®‰è£… JDKï¼Œç‰ˆæœ¬æ ¹æ®éœ€æ±‚è°ƒæ•´
      - name: å®‰è£…JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'  # ä½¿ç”¨ Temurin ä½œä¸º JDK å‘è¡Œç‰ˆ

      # ç”¨æ¥è¯»å–ymlï¼Œè·å–serverPort
      - name: å®‰è£… yq
        run: |
          sudo snap install yq || sudo apt-get update && sudo apt-get install -y yq

      # æ„å»ºé¡¹ç›®
      - name: ç”¨Mavenæ„å»ºé¡¹ç›®
        run: mvn clean package -DskipTests

      # åŠ¨æ€è·å– JAR æ–‡ä»¶åã€‚åœ¨ Maven æ„å»ºåï¼Œä» target/ ç›®å½•ä¸­æå–ç”Ÿæˆçš„ JAR æ–‡ä»¶å
      - name: è·å–JARæ–‡ä»¶åå’Œç«¯å£
        run: |
          ARTIFACT_ID=${ARTIFACT_ID:-$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout)}
          VERSION=${VERSION:-$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)}
          JAR_NAME=${JAR_NAME:-"${ARTIFACT_ID}-${VERSION}.jar"}
          PORT=${PORT:-$(yq e '.server.port' src/main/resources/application.yml)}
          if [ ! -f "target/${JAR_NAME}" ]; then
            echo "[ERROR] æœªæ‰¾åˆ° JAR æ–‡ä»¶ï¼štarget/${JAR_NAME}"
            exit 1
          fi
          if [ -z "$PORT" ]; then
            echo "[ERROR] æœªæ‰¾åˆ° server.port é…ç½®"
            exit 1
          fi
          echo "JAR_NAME=${JAR_NAME}" >> $GITHUB_ENV
          echo "PORT=${PORT}" >> $GITHUB_ENV
          echo "TAG_NAME=${VERSION}" >> $GITHUB_ENV
          echo "ARTIFACT_ID=${ARTIFACT_ID}" >> $GITHUB_ENV
          echo "DOCKER_IMAGE_TAG=${VERSION}" >> $GITHUB_ENV

      # æµ‹è¯•æœåŠ¡å™¨è¿æ¥
      - name: æµ‹è¯•æœåŠ¡å™¨è¿æ¥
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ env.SERVER_PASSWORD }}
          port: ${{ env.SERVER_PORT }}
          script: |
            echo "[$(date)] æœåŠ¡å™¨è¿æ¥æˆåŠŸ"

      # ä¸Šä¼  åœ¨æœåŠ¡å™¨åˆ›å»ºæ‰€éœ€ç›®å½•ï¼Œåˆ é™¤æ—§çš„ JAR æ–‡ä»¶ï¼Œåªä¿ç•™æœ€æ–°çš„ 10 ä¸ªæ–‡ä»¶
      - name: åˆ›å»ºæ‰€éœ€ç›®å½•å¹¶æ¸…ç†æ—§æ–‡ä»¶
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ env.SERVER_PASSWORD }}
          port: ${{ env.SERVER_PORT }}
          envs: REMOTE_JAR_DIR,JAR_NAME
          script: |
            echo "[$(date)] å‡†å¤‡éƒ¨ç½²æ–°ç‰ˆæœ¬åº”ç”¨..."
            # ç£ç›˜ç©ºé—´æ£€æŸ¥
            df -h $REMOTE_JAR_DIR | awk 'NR==2 {if ($4+0 < 500) {print "[$(date)] ç£ç›˜ç©ºé—´ä¸è¶³ï¼"; exit 1}}'
            # ç¡®ä¿ç›®æ ‡æ–‡ä»¶å¤¹å­˜åœ¨
            mkdir -p "$REMOTE_JAR_DIR"
            # è·å–å½“å‰æ—¶é—´æˆ³
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            
            # å¦‚æœæ–‡ä»¶å·²ç»å­˜åœ¨ï¼Œé‡å‘½åä¸ºå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶
            if [ -f "$REMOTE_JAR_DIR/$JAR_NAME" ]; then
              echo "[$(date)] å¤‡ä»½ç°æœ‰ JAR æ–‡ä»¶: ${JAR_NAME%.*}-$TIMESTAMP.jar"
              mv "$REMOTE_JAR_DIR/$JAR_NAME" "$REMOTE_JAR_DIR/${JAR_NAME%.*}-$TIMESTAMP.jar"
            fi
            
            # æ¸…ç†æ—§çš„ JAR æ–‡ä»¶ï¼Œåªä¿ç•™æœ€æ–°çš„ 10 ä¸ªæ–‡ä»¶
            cd "$REMOTE_JAR_DIR"
            echo "[$(date)] æ¸…ç†æ—§çš„ JAR æ–‡ä»¶..."
            find "$REMOTE_JAR_DIR" -maxdepth 1 -name "${JAR_NAME%.*}-*.jar" -printf '%T@ %p\n' | 
            sort -rn | awk 'NR>10 {print $2}' | xargs -r rm -f || echo "[$(date)] æ— æ—§ JAR æ–‡ä»¶å¯æ¸…ç†"
            
            # æ¸…ç†æ—§çš„æ—¥å¿—æ–‡ä»¶ï¼Œå€¼ä¿ç•™æœ€æ–°çš„10ä¸ª
            echo "[$(date)] æ¸…ç†æ—§çš„æ—¥å¿—æ–‡ä»¶ï¼Œåªä¿ç•™æœ€æ–°çš„ 10 ä¸ª..."
            find "$REMOTE_JAR_DIR" -maxdepth 1 -name "app-*.log" -printf '%T@ %p\n' |
            sort -rn | awk 'NR>10 {print $2}' | xargs -r rm -f || echo "[$(date)] æ— æ—§æ—¥å¿—æ–‡ä»¶å¯æ¸…ç†"
            
            # æ¸…ç†æ—§çš„å †è½¬å‚¨æ–‡ä»¶ï¼Œåªä¿ç•™æœ€æ–°çš„ 10 ä¸ª
            echo "[$(date)] æ¸…ç†æ—§çš„å †è½¬å‚¨æ–‡ä»¶..."
            find "$REMOTE_JAR_DIR" -maxdepth 1 -name "heapdump_*.hprof" -printf '%T@ %p\n' |
            sort -rn | awk 'NR>10 {print $2}' | xargs -r rm -f || echo "[$(date)] æ— æ—§å †è½¬å‚¨æ–‡ä»¶å¯æ¸…ç†"
            
            # æ¸…ç†æ—§çš„é”™è¯¯æ—¥å¿—æ–‡ä»¶ï¼Œåªä¿ç•™æœ€æ–°çš„ 10 ä¸ª
            echo "[$(date)] æ¸…ç†æ—§çš„é”™è¯¯æ—¥å¿—æ–‡ä»¶..."
            find "$REMOTE_JAR_DIR" -maxdepth 1 -name "hs_err_*.log" -printf '%T@ %p\n' |
            sort -rn | awk 'NR>10 {print $2}' | xargs -r rm -f || echo "[$(date)] æ— æ—§é”™è¯¯æ—¥å¿—æ–‡ä»¶å¯æ¸…ç†"

      - name: ä¸Šä¼ JaråŒ…åˆ°æœåŠ¡å™¨
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ env.SERVER_PASSWORD }}
          port: ${{ env.SERVER_PORT }}
          source: target/${{ env.JAR_NAME }}
          target: ${{ env.REMOTE_JAR_DIR }}
          strip_components: 1 # å»é™¤è·¯å¾„ä¸­çš„ä¸€çº§ç›®å½•ï¼Œä¹Ÿå°±æ˜¯targetï¼Œä¸ç„¶ä¼šæŠŠtargetæ–‡ä»¶å¤¹ä¹Ÿæ‹·è´è¿‡å»

      - name: éªŒè¯JaråŒ…æ˜¯å¦ä¸Šä¼ æˆåŠŸ
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ env.SERVER_PASSWORD }}
          port: ${{ env.SERVER_PORT }}
          envs: REMOTE_JAR_DIR,JAR_NAME  # ä¼ é€’ç¯å¢ƒå˜é‡
          script: |
            if [ ! -f "$REMOTE_JAR_DIR/$JAR_NAME" ]; then
              echo "[$(date)] JAR ä¸Šä¼ å¤±è´¥ï¼"
              exit 1
            fi
            echo "[$(date)] JAR æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: $(ls -lh $REMOTE_JAR_DIR/$JAR_NAME)"

      - name: é‡å¯JaråŒ…
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ env.SERVER_PASSWORD }}
          port: ${{ env.SERVER_PORT }}
          envs: REMOTE_JAR_DIR,JAR_NAME,PORT,JAVA_VERSION,AI_PLATFORM_CONFIG  # ä¼ é€’ç¯å¢ƒå˜é‡
          script: |
            echo "[$(date)] å‡†å¤‡é‡å¯åº”ç”¨..."
            
            # javaç‰ˆæœ¬æ£€æŸ¥
            REQUIRED_JAVA="java version \"${JAVA_VERSION}"
            echo "[$(date)] æ£€æŸ¥ Java ç‰ˆæœ¬..."
            if ! java -version 2>&1 | grep -E "version \"${JAVA_VERSION}(\.|$)"; then
              echo "[$(date)] Java ç‰ˆæœ¬ä¸åŒ¹é…ï¼éœ€è¦ Java ${JAVA_VERSION}.x"
              java -version 2>&1
              exit 1
            fi
            
            # æ£€æŸ¥å¹¶ç»ˆæ­¢ JAR è¿›ç¨‹æˆ–ç«¯å£å ç”¨
            JAR_PATTERN="java.*-jar.*${JAR_NAME%.*}"
            PIDS=$(pgrep -f "$JAR_PATTERN")
            PORT_PID=$(ss -tulnp 2>/dev/null | grep -E ":${PORT}\s" | awk -F',' '{print $2}' | awk -F'pid=' '{print $2}' | head -n 1)
            ALL_PIDS="$PIDS $PORT_PID"
            if [ -n "$ALL_PIDS" ]; then
              echo "[$(date)] å‘ç°è¿›ç¨‹ PIDs: $ALL_PIDS"
              for PID in $ALL_PIDS; do
                if [ -n "$PID" ] && ps -p $PID > /dev/null; then
                  echo "[$(date)] å°è¯•ç»ˆæ­¢è¿›ç¨‹ $PID..."
                  kill -15 $PID
                fi
              done
              sleep 15
              for PID in $ALL_PIDS; do
                if [ -n "$PID" ] && ps -p $PID > /dev/null; then
                  echo "[$(date)] è¿›ç¨‹ $PID æœªæ­£å¸¸ç»ˆæ­¢ï¼Œå¼ºåˆ¶åœæ­¢..."
                  kill -9 $PID
                fi
              done
            else
              echo "[$(date)] æœªæ‰¾åˆ°è¿è¡Œä¸­çš„ JAR è¿›ç¨‹æˆ–å ç”¨ ${PORT} ç«¯å£çš„è¿›ç¨‹"
            fi
            
            # å¯åŠ¨åº”ç”¨
            echo "[$(date)] å¯åŠ¨åº”ç”¨: $JAR_NAME"
            cd $REMOTE_JAR_DIR
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            if [ -f "$REMOTE_JAR_DIR/app.log" ]; then
              echo "[$(date)] å¤‡ä»½ç°æœ‰æ—¥å¿—æ–‡ä»¶: app-$TIMESTAMP.log"
              mv "$REMOTE_JAR_DIR/app.log" "$REMOTE_JAR_DIR/app-$TIMESTAMP.log"
            fi
            
            # èµ„æºé™åˆ¶
            nohup java \
              -Xms512m -Xmx1024m \
              -XX:+UseG1GC \
              -XX:+HeapDumpOnOutOfMemoryError \
              -XX:HeapDumpPath=$REMOTE_JAR_DIR/heapdump_$(date +%s).hprof \
              -XX:ErrorFile=$REMOTE_JAR_DIR/hs_err_%p.log \
              -jar $JAR_NAME --server.port=$PORT > app.log 2>&1 &
            sleep 30
            
            # è¿›ç¨‹æ£€æŸ¥
            ps aux | grep "[j]ava.*-jar $JAR_NAME" || echo "[$(date)] æ— åŒ¹é…çš„ Java è¿›ç¨‹"
            if pgrep -f "java.*-jar $JAR_NAME" > /dev/null; then
              echo "[$(date)] è¿›ç¨‹æ£€æŸ¥é€šè¿‡ï¼Œåº”ç”¨å·²æˆåŠŸå¯åŠ¨ï¼"
              #echo "[$(date)] æ‰“å° $REMOTE_JAR_DIR/app.log çš„å‰ 50 è¡Œæ—¥å¿—ï¼š"
              #head -n 50 $REMOTE_JAR_DIR/app.log || echo "[$(date)] æ— æ³•è¯»å–æ—¥å¿—æ–‡ä»¶ï¼"
            else
              echo "[$(date)] åº”ç”¨å¯åŠ¨å¤±è´¥ï¼"
              echo "[$(date)] æ‰“å° $REMOTE_JAR_DIR/app.log çš„å‰ 50 è¡Œæ—¥å¿—ï¼ˆè‹¥å­˜åœ¨ï¼‰ï¼š"
              head -n 50 $REMOTE_JAR_DIR/app.log || echo "[$(date)] æ— æ³•è¯»å–æ—¥å¿—æ–‡ä»¶ï¼"
              exit 1
            fi
            
            # æ¥å£å¥åº·æ£€æŸ¥
            HEALTH_URL="http://localhost:$PORT/api/actuator/health"
            MAX_RETRIES=10
            RETRY_INTERVAL=5

            # ç¡®ä¿ curl å¯ç”¨
            if ! command -v curl &> /dev/null; then
              echo "[$(date)] curl æœªå®‰è£…ï¼Œå°è¯•å®‰è£…..."
              apt-get update && apt-get install -y curl
            fi
            for i in $(seq 1 $MAX_RETRIES); do
              STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL")
              if [ "$STATUS_CODE" -eq 200 ]; then
                echo "[$(date)] æ¥å£å¥åº·æ£€æŸ¥é€šè¿‡ âœ…"
                break
              else
                echo "[$(date)] ç¬¬ $i æ¬¡æ¥å£æ£€æŸ¥å¤±è´¥ï¼ˆçŠ¶æ€ç  $STATUS_CODEï¼‰ï¼Œé‡è¯•ä¸­..."
                sleep $RETRY_INTERVAL
              fi

              if [ "$i" -eq "$MAX_RETRIES" ]; then
                echo "[$(date)] åº”ç”¨æ¥å£å¥åº·æ£€æŸ¥å¤±è´¥ âŒ"
                head -n 50 $REMOTE_JAR_DIR/app.log || echo "[$(date)] æ— æ³•è¯»å–æ—¥å¿—æ–‡ä»¶ï¼"
                exit 1
              fi
            done

            echo "[$(date)] åº”ç”¨å¯åŠ¨æˆåŠŸå¹¶å¥åº·è¿è¡Œ ğŸ‰"
            head -n 50 $REMOTE_JAR_DIR/app.log || echo "[$(date)] æ— æ³•è¯»å–æ—¥å¿—æ–‡ä»¶ï¼"

      # ç™»å½• DockerHub
      - name: ç™»å½•Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}
      # ç™»å½• GHCRï¼ˆgithub repository container registerï¼‰,ä¹Ÿå°±æ˜¯githubçš„dockeråº“
      - name: ç™»å½•GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      # æ„å»ºDockeré•œåƒï¼ˆDockerHubï¼‰
      - name: æ„å»ºDockeré•œåƒ
        run: |
          docker build \
            --build-arg JAR_FILE=target/${{ env.JAR_NAME }} \
            -t ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }} \
            -t ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest \
            -t ghcr.io/${{ github.repository_owner }}/${{ env.GHCR_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }} \
            -t ghcr.io/${{ github.repository_owner }}/${{ env.GHCR_IMAGE_NAME }}:latest \
            .
      # æ¨é€Dockeré•œåƒï¼ˆDockerHubï¼‰
      - name: æ¨é€Dockeré•œåƒ
        run: |
          echo "Pushing to ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}"
          docker push ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}
          echo "Pushing to ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest"
          docker push ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest

      # æ¨é€Dockeré•œåƒåˆ°GHCRï¼ˆgithub repository container registerï¼‰,ä¹Ÿå°±æ˜¯githubçš„dockeråº“
      # æ‹‰å–æ˜¯è¿™æ ·ï¼šdocker pull ghcr.io/YOUR_USERNAME/GHCR_IMAGE_NAME:tag
      - name: æ¨é€Dockeré•œåƒåˆ°GHCR
        run: |
          echo "Pushing to ghcr.io/${{ github.repository_owner }}/${{ env.GHCR_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}"
          docker push ghcr.io/${{ github.repository_owner }}/${{ env.GHCR_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}
          echo "Pushing to ghcr.io/${{ github.repository_owner }}/${{ env.GHCR_IMAGE_NAME }}:latest"
          docker push ghcr.io/${{ github.repository_owner }}/${{ env.GHCR_IMAGE_NAME }}:latest

      # åˆ›å»º GitHub Releaseï¼Œå½“åˆ›å»ºä»¥v*å¼€å¤´çš„tagæ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºreleaseï¼Œå°±æ˜¯å¼€å¤´å®šä¹‰çš„é‚£ä¸ªv*ï¼Œæ¯”å¦‚v1.0.1
      - name: åˆ›å»º GitHub Release
        id: create_release  # æ–°å¢ ID ä»¥ä¾›åç»­æ­¥éª¤å¼•ç”¨
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/create-release@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.TAG_NAME }}
          release_name: ${{ env.TAG_NAME }}
          body: |
            #  ${{ env.ARTIFACT_ID }} ${{ env.TAG_NAME }}
            - è‡ªåŠ¨æ„å»ºå¹¶éƒ¨ç½² JAR æ–‡ä»¶: ${{ env.JAR_NAME }}
            - ç«¯å£: ${{ env.PORT }}
            - æ–°å¢åŠŸèƒ½å’Œä¿®å¤ï¼ˆè¯·æ ¹æ®å®é™…å˜æ›´æ›´æ–°ï¼Œè¿™é‡Œä¸å˜äº†ï¼Œè‡ªå·±å»githubçš„releaseé¡µé¢æ”¹ï¼‰ã€‚
          draft: false
          prerelease: false

      # ä¸Šä¼  å‘å¸ƒreleaseåï¼Œè‡ªåŠ¨ä¸Šä¼ jaråŒ…åˆ°release
      - name: ä¸Šä¼  JAR åˆ° Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-release-asset@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: target/${{ env.JAR_NAME }}
          asset_name: ${{ env.JAR_NAME }}
          asset_content_type: application/java-archive