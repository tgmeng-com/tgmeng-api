name: éƒ¨ç½²tgmeng-api

on:
  push:
    branches:
      - main  # è§¦å‘æ¡ä»¶ï¼Œæ ¹æ®ä½ çš„éœ€æ±‚é€‰æ‹©åˆ†æ”¯
    tags:
      - 'v*'  # è§¦å‘ Release åˆ›å»ºçš„æ ‡ç­¾æ¨¡å¼ï¼Œä¾‹å¦‚ v1.0.0ã€‚æ„æ€å°±æ˜¯å½“ä½ åˆ›å»ºä¸€ä¸ªä»¥vå¼€å¤´çš„tagæ—¶ï¼Œä¼šè‡ªåŠ¨å‘å¸ƒreleaseï¼Œè¿™éƒ¨åˆ†è‡ªåŠ¨å‘å¸ƒreleaseçš„é…ç½®åœ¨æœ€åé¢é‚£é‡Œï¼Œç¿»ä¸‹å»çœ‹

concurrency: # å¦‚æœå¤šä¸ªéƒ¨ç½²åŒæ—¶è§¦å‘ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨ä¸Šçš„ JAR æ–‡ä»¶å†²çªæˆ–è¦†ç›–ã€‚å»ºè®®ä½¿ç”¨ concurrency é™åˆ¶åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªéƒ¨ç½²è¿è¡Œ
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true


permissions:
  contents: write  # è¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†åœ¨æäº¤tagæ—¶ä»–è‡ªåŠ¨åˆ›å»ºreleaseå’Œä¸Šä¼ jaråŒ…éœ€è¦è¿™å„¿æƒé™
  packages: write  # æ·»åŠ å¯¹ packages çš„å†™å…¥æƒé™ï¼Œä»¥ä¾¿æ¨é€ GHCR é•œåƒï¼ˆgithub repository container registerï¼‰

jobs:
  deploy:
    runs-on: ubuntu-latest   # é€‰æ‹©è¿è¡Œç¯å¢ƒï¼Œubuntu-latest æ˜¯ Linux ç³»ç»Ÿ
    timeout-minutes: 30      # å•ä½ï¼šåˆ†é’Ÿ  å½“å‰çš„å·¥ä½œæµæ²¡æœ‰è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚å¦‚æœæŸä¸ªæ­¥éª¤ï¼ˆå¦‚ Maven æ„å»ºæˆ– SSH å‘½ä»¤ï¼‰å¡ä½ï¼Œå¯èƒ½å¯¼è‡´å·¥ä½œæµé•¿æ—¶é—´æŒ‚èµ·
    env:
      SERVER_HOST: ${{ secrets.SERVER_IP }}                          # æœåŠ¡å™¨ IP  åœ¨https://github.com/ç”¨æˆ·å/ä»“åº“å/settings/secrets/actions é‡Œè®¾ç½® Repository secrets
      SERVER_USER: ${{ secrets.SERVER_USER }}                        # æœåŠ¡å™¨ç”¨æˆ·å
      SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}                # æœåŠ¡å™¨å¯†ç 
      SERVER_PORT: 22                                                # æœåŠ¡å™¨ç«¯å£
      JAVA_VERSION: '21'                                             # javaç‰ˆæœ¬
      REMOTE_APP_DIR: /home/${{ secrets.SERVER_USER }}/tgmeng-api    # éƒ¨ç½²ç›®å½•ï¼Œæˆ‘æ˜¯rootç”¨æˆ·ç™»å½•ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¼šå˜æˆ/home/root/tgmeng-api
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}          # DockerHub ç”¨æˆ·å
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}                # DockerHub è®¿é—®ä»¤ç‰Œ
      DOCKER_IMAGE_NAME: tgmeng-api                                  # DockerHub é•œåƒåç§°ï¼ˆä¹Ÿå°±æ˜¯dockerHubé‡Œé¢çš„ä»“åº“çš„åå­—ï¼‰
      CONTAINER_NAME: tgmeng-api
      GHCR_IMAGE_NAME: tgmeng-api                                   # GHCR é•œåƒåç§°ï¼ˆå»ºè®®æ˜¯ä»“åº“åï¼‰
      AI_PLATFORM_CONFIG: ${{ secrets.AI_PLATFORM_CONFIG }}
      GOOGLE_ADS_CLOSE_PASSWORD: ${{ secrets.GOOGLE_ADS_CLOSE_PASSWORD }}
      SUBSCRIPTION_FILE_INIT_PASSWORD: ${{ secrets.SUBSCRIPTION_FILE_INIT_PASSWORD }}
      UMAMI_WEBSITE_TGMENG_COM: ${{ secrets.UMAMI_WEBSITE_TGMENG_COM }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}

    steps:
      # è·å–ä»£ç å¹¶æ„å»ºé¡¹ç›®
      - name: æ‹‰å–é¡¹ç›®ä»£ç 
        uses: actions/checkout@v4

      # å®‰è£… JDKï¼Œç‰ˆæœ¬æ ¹æ®éœ€æ±‚è°ƒæ•´
      - name: å®‰è£…JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'  # ä½¿ç”¨ Temurin ä½œä¸º JDK å‘è¡Œç‰ˆ

      # ç”¨æ¥è¯»å–ymlï¼Œè·å–serverPort
      - name: å®‰è£… yq
        run: |
          sudo snap install yq || sudo apt-get update && sudo apt-get install -y yq

      # æ„å»ºé¡¹ç›®
      - name: ç”¨Mavenæ„å»ºé¡¹ç›®
        run: mvn clean package -DskipTests

      # åŠ¨æ€è·å– JAR æ–‡ä»¶åã€‚åœ¨ Maven æ„å»ºåï¼Œä» target/ ç›®å½•ä¸­æå–ç”Ÿæˆçš„ JAR æ–‡ä»¶å
      - name: è·å–JARæ–‡ä»¶åå’Œç«¯å£
        run: |
          ARTIFACT_ID=${ARTIFACT_ID:-$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout)}
          VERSION=${VERSION:-$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)}
          JAR_NAME=${JAR_NAME:-"${ARTIFACT_ID}-${VERSION}.jar"}
          PORT=${PORT:-$(yq e '.server.port' src/main/resources/application.yml)}
          if [ ! -f "target/${JAR_NAME}" ]; then
            echo "[ERROR] æœªæ‰¾åˆ° JAR æ–‡ä»¶ï¼štarget/${JAR_NAME}"
            exit 1
          fi
          if [ -z "$PORT" ]; then
            echo "[ERROR] æœªæ‰¾åˆ° server.port é…ç½®"
            exit 1
          fi
          echo "JAR_NAME=${JAR_NAME}" >> $GITHUB_ENV
          echo "PORT=${PORT}" >> $GITHUB_ENV
          echo "TAG_NAME=${VERSION}" >> $GITHUB_ENV
          echo "ARTIFACT_ID=${ARTIFACT_ID}" >> $GITHUB_ENV
          echo "DOCKER_IMAGE_TAG=${VERSION}" >> $GITHUB_ENV

      # æµ‹è¯•æœåŠ¡å™¨è¿æ¥
      - name: æµ‹è¯•æœåŠ¡å™¨è¿æ¥
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ env.SERVER_PASSWORD }}
          port: ${{ env.SERVER_PORT }}
          script: |
            echo "[$(date)] æœåŠ¡å™¨è¿æ¥æˆåŠŸ"

      # ä¸Šä¼  åœ¨æœåŠ¡å™¨åˆ›å»ºæ‰€éœ€ç›®å½•ï¼Œåˆ é™¤æ—§æ–‡ä»¶
      - name: åˆ›å»ºæ‰€éœ€ç›®å½•å¹¶æ¸…ç†æ—§æ–‡ä»¶
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ env.SERVER_PASSWORD }}
          port: ${{ env.SERVER_PORT }}
          envs: REMOTE_APP_DIR,JAR_NAME
          script: |
            echo "[$(date)] å‡†å¤‡éƒ¨ç½²æ–°ç‰ˆæœ¬åº”ç”¨..."
            # ç£ç›˜ç©ºé—´æ£€æŸ¥
            df -h $REMOTE_APP_DIR | awk 'NR==2 {if ($4+0 < 500) {print "[$(date)] ç£ç›˜ç©ºé—´ä¸è¶³ï¼"; exit 1}}'
            # ç¡®ä¿ç›®æ ‡æ–‡ä»¶å¤¹å­˜åœ¨
            mkdir -p "$REMOTE_APP_DIR/logs"
            mkdir -p "$REMOTE_APP_DIR/data"
            mkdir -p "$REMOTE_APP_DIR/heapdumps"
            
            # æ¸…ç†æ—§çš„æ—¥å¿—æ–‡ä»¶ï¼Œå€¼ä¿ç•™æœ€æ–°çš„10ä¸ª
            echo "[$(date)] æ¸…ç†æ—§çš„æ—¥å¿—æ–‡ä»¶ï¼Œåªä¿ç•™æœ€æ–°çš„ 10 ä¸ª..."
            find "$REMOTE_APP_DIR/logs" -maxdepth 1 -name "app-*.log" -printf '%T@ %p\n' |
            sort -rn | awk 'NR>10 {print $2}' | xargs -r rm -f || echo "[$(date)] æ— æ—§æ—¥å¿—æ–‡ä»¶å¯æ¸…ç†"
            
            # æ¸…ç†æ—§çš„å †è½¬å‚¨æ–‡ä»¶ï¼Œåªä¿ç•™æœ€æ–°çš„ 10 ä¸ª
            echo "[$(date)] æ¸…ç†æ—§çš„å †è½¬å‚¨æ–‡ä»¶..."
            find "$REMOTE_APP_DIR/heapdumps" -maxdepth 1 -name "heapdump_*.hprof" -printf '%T@ %p\n' |
            sort -rn | awk 'NR>5 {print $2}' | xargs -r rm -f || echo "[$(date)] æ— æ—§å †è½¬å‚¨æ–‡ä»¶å¯æ¸…ç†"
            
            # æ¸…ç†æ—§çš„é”™è¯¯æ—¥å¿—æ–‡ä»¶ï¼Œåªä¿ç•™æœ€æ–°çš„ 10 ä¸ª
            echo "[$(date)] æ¸…ç†æ—§çš„é”™è¯¯æ—¥å¿—æ–‡ä»¶..."
            find "$REMOTE_APP_DIR" -maxdepth 1 -name "hs_err_*.log" -printf '%T@ %p\n' |
            sort -rn | awk 'NR>10 {print $2}' | xargs -r rm -f || echo "[$(date)] æ— æ—§é”™è¯¯æ—¥å¿—æ–‡ä»¶å¯æ¸…ç†"

      # æ„å»ºDockeré•œåƒï¼ˆDockerHubï¼‰
      - name: æ„å»ºDockeré•œåƒ
        run: |
          docker build \
            --build-arg JAR_FILE=target/${{ env.JAR_NAME }} \
            -t ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }} \
            -t ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest \
            -t ghcr.io/${{ github.repository_owner }}/${{ env.GHCR_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }} \
            -t ghcr.io/${{ github.repository_owner }}/${{ env.GHCR_IMAGE_NAME }}:latest \
            .

      # ç™»å½• DockerHub
      - name: ç™»å½•Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      # æ¨é€Dockeré•œåƒï¼ˆDockerHubï¼‰
      - name: æ¨é€Dockeré•œåƒ
        run: |
          echo "Pushing to ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}"
          docker push ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}
          echo "Pushing to ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest"
          docker push ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest

      - name: éƒ¨ç½²å¹¶æµ‹è¯•Dockerå®¹å™¨
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ env.SERVER_PASSWORD }}
          port: ${{ env.SERVER_PORT }}
          envs: DOCKERHUB_USERNAME,DOCKERHUB_TOKEN,DOCKER_IMAGE_NAME,DOCKER_IMAGE_TAG,CONTAINER_NAME,PORT,REMOTE_APP_DIR,AI_PLATFORM_CONFIG,ADMIN_PASSWORD,GOOGLE_ADS_CLOSE_PASSWORD,SUBSCRIPTION_FILE_INIT_PASSWORD,UMAMI_WEBSITE_TGMENG_COM
          script: |
            echo "[$(date)] å‡†å¤‡éƒ¨ç½²å¹¶æµ‹è¯• Docker å®¹å™¨..."
            
            if ! command -v docker &> /dev/null; then
              echo "[$(date)] Docker æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Dockerï¼"
              exit 1
            fi
            
            # ç™»å½• DockerHubï¼ˆç”¨äºæ‹‰å–åŸºç¡€é•œåƒï¼Œå¦‚æœéœ€è¦ï¼‰
            echo "[$(date)] ç™»å½• DockerHub..."
            echo "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin
            
            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "[$(date)] æ‹‰å–é•œåƒ: ${DOCKERHUB_USERNAME}/${DOCKER_IMAGE_NAME}:latest"
            docker pull ${DOCKERHUB_USERNAME}/${DOCKER_IMAGE_NAME}:latest
            
            # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
            if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
              echo "[$(date)] åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨..."
              docker stop ${CONTAINER_NAME} || true
              docker rm ${CONTAINER_NAME} || true
            fi
            
            # æ¸…ç†æ—§é•œåƒï¼ˆæ‹‰å–æ–°çš„é•œåƒåï¼Œæ—§çš„é•œåƒçš„TAGä¼šå˜æˆNoneï¼Œä¹Ÿå°±æ˜¯æ‚¬ç©ºé•œåƒï¼‰
            echo "[$(date)] æ¸…ç†æ‚¬ç©ºé•œåƒï¼ˆdangling imagesï¼‰..."
            docker image prune -f || echo "[$(date)] æ— æ‚¬ç©ºé•œåƒå¯æ¸…ç†"
            
            # å¤‡ä»½å½“å‰æ—¥å¿—
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            if [ -f "${REMOTE_APP_DIR}/logs/app.log" ]; then
              echo "[$(date)] å¤‡ä»½ç°æœ‰æ—¥å¿—æ–‡ä»¶"
              mv "${REMOTE_APP_DIR}/logs/app.log" "${REMOTE_APP_DIR}/logs/app-${TIMESTAMP}.log"
            fi
            
            # å¯åŠ¨æ–°å®¹å™¨
            echo "[$(date)] å¯åŠ¨æ–°å®¹å™¨..."
            docker run -d \
              --name ${CONTAINER_NAME} \
              --restart unless-stopped \
              -p ${PORT}:${PORT} \
              -v ${REMOTE_APP_DIR}/logs:/app/logs \
              -v ${REMOTE_APP_DIR}/data:/app/data \
              -v ${REMOTE_APP_DIR}/heapdumps:/app/heapdumps \
              -e SERVER_PORT=${PORT} \
              -e AI_PLATFORM_CONFIG="${AI_PLATFORM_CONFIG}" \
              -e ADMIN_PASSWORD="${ADMIN_PASSWORD}" \
              -e GOOGLE_ADS_CLOSE_PASSWORD="${GOOGLE_ADS_CLOSE_PASSWORD}" \
              -e SUBSCRIPTION_FILE_INIT_PASSWORD="${SUBSCRIPTION_FILE_INIT_PASSWORD}" \
              -e UMAMI_WEBSITE_TGMENG_COM="${UMAMI_WEBSITE_TGMENG_COM}" \
              -e JAVA_OPTS="-Xms512m -Xmx1024m -XX:+UseG1GC -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/app/heapdumps -XX:ErrorFile=/app/logs/hs_err_%p.log" \
              -e TZ=Asia/Shanghai \
              ${DOCKERHUB_USERNAME}/${DOCKER_IMAGE_NAME}:latest
            
            # ç­‰å¾…å®¹å™¨å¯åŠ¨
            sleep 30
            
            # æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œ
            if ! docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
              echo "[$(date)] âŒ å®¹å™¨å¯åŠ¨å¤±è´¥ï¼"
              echo "[$(date)] å®¹å™¨æ—¥å¿—ï¼š"
              docker logs ${CONTAINER_NAME} || true
              exit 1
            fi
            
            echo "[$(date)] âœ… å®¹å™¨å¯åŠ¨æˆåŠŸï¼"
            docker ps | grep ${CONTAINER_NAME}
            
            # å¥åº·æ£€æŸ¥
            HEALTH_URL="http://localhost:${PORT}/api/actuator/health"
            MAX_RETRIES=10
            RETRY_INTERVAL=5
            
            echo "[$(date)] å¼€å§‹å¥åº·æ£€æŸ¥..."
            for i in $(seq 1 ${MAX_RETRIES}); do
              STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${HEALTH_URL}" || echo "000")
              if [ "${STATUS_CODE}" -eq 200 ]; then
                echo "[$(date)] âœ… æ¥å£å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
                break
              else
                echo "[$(date)] ç¬¬ ${i}/${MAX_RETRIES} æ¬¡æ£€æŸ¥å¤±è´¥ï¼ˆçŠ¶æ€ç  ${STATUS_CODE}ï¼‰ï¼Œ${RETRY_INTERVAL}ç§’åé‡è¯•..."
                sleep ${RETRY_INTERVAL}
              fi
            
              if [ "${i}" -eq "${MAX_RETRIES}" ]; then
                echo "[$(date)] âŒ åº”ç”¨æ¥å£å¥åº·æ£€æŸ¥å¤±è´¥ï¼"
                echo "[$(date)] å®¹å™¨æ—¥å¿—ï¼ˆæœ€å100è¡Œï¼‰ï¼š"
                docker logs --tail 100 ${CONTAINER_NAME}
                echo "[$(date)] å›æ»šï¼šåœæ­¢å¹¶åˆ é™¤å¤±è´¥çš„å®¹å™¨..."
                docker stop ${CONTAINER_NAME} || true
                docker rm ${CONTAINER_NAME} || true
                exit 1
              fi
            done
            
            echo "[$(date)] ğŸ‰ åº”ç”¨éƒ¨ç½²æˆåŠŸå¹¶å¥åº·è¿è¡Œï¼"
            echo "[$(date)] å®¹å™¨èµ„æºä½¿ç”¨æƒ…å†µï¼š"
            docker stats --no-stream ${CONTAINER_NAME}

      # ç™»å½• GHCRï¼ˆgithub repository container registerï¼‰,ä¹Ÿå°±æ˜¯githubçš„dockeråº“
      - name: ç™»å½•GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # æ¨é€Dockeré•œåƒåˆ°GHCRï¼ˆgithub repository container registerï¼‰,ä¹Ÿå°±æ˜¯githubçš„dockeråº“
      # æ‹‰å–æ˜¯è¿™æ ·ï¼šdocker pull ghcr.io/YOUR_USERNAME/GHCR_IMAGE_NAME:tag
      - name: æ¨é€Dockeré•œåƒåˆ°GHCR
        run: |
          echo "Pushing to ghcr.io/${{ github.repository_owner }}/${{ env.GHCR_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}"
          docker push ghcr.io/${{ github.repository_owner }}/${{ env.GHCR_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}
          echo "Pushing to ghcr.io/${{ github.repository_owner }}/${{ env.GHCR_IMAGE_NAME }}:latest"
          docker push ghcr.io/${{ github.repository_owner }}/${{ env.GHCR_IMAGE_NAME }}:latest